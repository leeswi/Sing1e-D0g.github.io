<!DOCTYPE html><html class="theme-next muse use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/title.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/title.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/title.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="web,代码审计,X'nuca,"><meta name="description" content="0x01 题目题目当时没有做，只把源代码压缩包下下来了，赛后看大佬wp，准备复现一下。本地复现的话由于数据库等种种原因失败了。只能参考ROIS大佬wp练一下代码审计了。百度网盘下载源码"><meta name="keywords" content="web,代码审计,X&#39;nuca"><meta property="og:type" content="article"><meta property="og:title" content="X&#39;nuca2018-hardphp代码审计"><meta property="og:url" content="http://leeswi.github.io/2018/12/08/20181207：X'nuca2018-hardphp代码审计/index.html"><meta property="og:site_name" content="Sing1e-D0g的笔记"><meta property="og:description" content="0x01 题目题目当时没有做，只把源代码压缩包下下来了，赛后看大佬wp，准备复现一下。本地复现的话由于数据库等种种原因失败了。只能参考ROIS大佬wp练一下代码审计了。百度网盘下载源码"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://images2015.cnblogs.com/blog/713681/201609/713681-20160927202126703-1598547018.png"><meta property="og:image" content="https://i.loli.net/2018/12/19/5c1a2a859395f.png"><meta property="og:image" content="https://i.loli.net/2018/12/15/5c146d861a478.png"><meta property="og:image" content="https://i.loli.net/2018/12/15/5c1460d314f59.png"><meta property="og:image" content="https://i.loli.net/2018/12/17/5c174c44db08c.png"><meta property="og:image" content="https://i.loli.net/2018/12/22/5c1d8f2b1a308.png"><meta property="og:image" content="https://i.loli.net/2018/12/22/5c1d902806b10.png"><meta property="og:image" content="https://i.loli.net/2018/12/24/5c20d0dbb60ce.png"><meta property="og:image" content="https://i.loli.net/2018/12/24/5c20d14309a92.png"><meta property="og:image" content="https://i.loli.net/2018/12/24/5c20d19746872.png"><meta property="og:updated_time" content="2018-12-24T12:37:28.507Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="X&#39;nuca2018-hardphp代码审计"><meta name="twitter:description" content="0x01 题目题目当时没有做，只把源代码压缩包下下来了，赛后看大佬wp，准备复现一下。本地复现的话由于数据库等种种原因失败了。只能参考ROIS大佬wp练一下代码审计了。百度网盘下载源码"><meta name="twitter:image" content="https://images2015.cnblogs.com/blog/713681/201609/713681-20160927202126703-1598547018.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://leeswi.github.io/2018/12/08/20181207：X'nuca2018-hardphp代码审计/"><title>X'nuca2018-hardphp代码审计 | Sing1e-D0g的笔记</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Sing1e-D0g的笔记</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="menu-item-icon fa fa-fw fa-calendar"></i><br>日程表</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>站点地图</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>公益404</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://leeswi.github.io/2018/12/08/20181207：X'nuca2018-hardphp代码审计/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Sing1e-D0g"><meta itemprop="description" content=""><meta itemprop="image" content="/images/header.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Sing1e-D0g的笔记"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">X'nuca2018-hardphp代码审计</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-08T10:59:37+08:00">2018-12-08 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="0x01-题目"><a href="#0x01-题目" class="headerlink" title="0x01 题目"></a>0x01 题目</h2><p>题目当时没有做，只把源代码压缩包下下来了，赛后看大佬wp，准备复现一下。本地复现的话由于数据库等种种原因失败了。只能参考ROIS大佬wp练一下代码审计了。</p><p><a href="https://pan.baidu.com/s/19NZdhoVbFy9shYxLJ58znw" target="_blank" rel="noopener">百度网盘下载源码</a><br><a id="more"></a></p><h2 id="0x02-简单分析"><a href="#0x02-简单分析" class="headerlink" title="0x02 简单分析"></a>0x02 简单分析</h2><p><img src="https://images2015.cnblogs.com/blog/713681/201609/713681-20160927202126703-1598547018.png" alt=""></p><p>题目要求是Getshell，源代码典型的MVC架构，一个典型的Web MVC流程：</p><ul><li>Controller截获用户发出的请求；</li><li>Controller调用Model完成状态的读写操作；</li><li>Controller把数据传递给View；</li><li>View渲染最终结果并呈献给用户。</li></ul><p>(涉及到php MVC开发请参考这篇文章，对于相关代码审计的理解及结构也有很大帮助–&gt;<a href="http://www.cnblogs.com/Steven-shi/p/5914175.html" target="_blank" rel="noopener">http://www.cnblogs.com/Steven-shi/p/5914175.html</a>)</p><p>所给代码主要有这么几个文件(夹)：</p><ul><li><p>config.php （配置文件）</p></li><li><p>index.php （入口文件）</p></li><li><p>view （视图类文件夹）</p></li><li><p>model （模型类文件夹）</p></li><li><p>controller控制器文件夹里的BaseController.php和mainController.php<br>这两个文件是主要文件，主要是对其他文件定义的类进行调用，包括跳转动作，登录会话处理，注册上传等等。</p></li><li><p>include文件夹两个文件MySessionHandler.php和Session.php两个文件，主要处理session会话处理。</p></li><li><p>lib文件夹里core.ph（共用框架入口文件）。这个文件被index包含，个人感觉类似主文件，涉及到输入参数的过滤处理和关键函数的定义以及关键类的定义（MVC类）</p></li></ul><h2 id="0x03-core-php文件分析"><a href="#0x03-core-php文件分析" class="headerlink" title="0x03 core.php文件分析"></a>0x03 core.php文件分析</h2><p>首先是63~66行对输入参数的处理：<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">escape($_REQUEST);</span><br><span class="line">escape($_POST);</span><br><span class="line">escape($_GET);</span><br><span class="line">escape($_SERVER);</span><br><span class="line"></span><br><span class="line"><span class="comment">//escape函数在153行定义</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span><span class="params">(&amp;$arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(is_array($arg)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($arg <span class="keyword">as</span> &amp;$value) &#123;</span><br><span class="line">            escape($value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $arg = str_replace([<span class="string">"'"</span>, <span class="string">'\\'</span>, <span class="string">'('</span>, <span class="string">')'</span>], [<span class="string">"‘"</span>, <span class="string">'\\\\'</span>, <span class="string">'（'</span>, <span class="string">'）'</span>], $arg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>可以看出 escape 对输入参数进行了黑名单替换。括号被过滤的话基本上注入比较难了。</p><p>涉及到MVC框架的实现，代码定义了三个类：Controller（控制器）、Model（模型）、View（视图），function url 进行了路由设置。</p><p>最重要的是在78~79行进行了 <strong><font color="red">控制器类的实例化</font></strong><br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$controller_obj = <span class="keyword">new</span> $controller_name();   <span class="comment">//实例化mainController类</span></span><br><span class="line">$controller_obj-&gt;$action_name(); <span class="comment">//执行的动作actionindex</span></span><br></pre></td></tr></table></figure><p></p><p>controller_name()是在45和67行定义的。系统首先执行的mainController类中的actionIndex方法。</p><h2 id="0x04-Controller控制器分析"><a href="#0x04-Controller控制器分析" class="headerlink" title="0x04 Controller控制器分析"></a>0x04 Controller控制器分析</h2><p>上面mainController类在 mainController.php 文件中定义，下面分析两个控制器文件。<br>mainController继承了BaseController：BaseControlller主要是初始化了session，下面是代码<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $layout = <span class="string">"layout.html"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">  ini_set(<span class="string">'session.save_handler'</span>, <span class="string">'user'</span>);</span><br><span class="line">  $handler = <span class="keyword">new</span> MySessionHandler();</span><br><span class="line">  session_set_save_handler($handler, <span class="keyword">true</span>);</span><br><span class="line">  session_start();</span><br><span class="line">  header(<span class="string">"Content-type: text/html; charset=utf-8"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//..</span></span><br></pre></td></tr></table></figure><p></p><p>主要文件是mainController。<strong><font color="red">mainController是对BaseCrotroller的继承，定义了登录（actionLogin）、注册（actionRegister）、上传（actionUploader）、信息（actionMessage）、提交（actionPOST）等方法。</font></strong><br>首先看actionIndex函数：<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">isset</span>($_SESSION[<span class="string">"data"</span>]))&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;jump(<span class="string">"/main/login"</span>);</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>首先进行的判定就是是否存在$_SESSION[‘data’]，如果没有就跳到登录界面。登陆请求的url对应控制器里的actionLogin动作。如果没有账号的会进行actionRegister动作。</p><p>下面代码是注册：<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">actionRegister</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>($_POST)&#123;</span><br><span class="line">  	$username = arg(<span class="string">'username'</span>);</span><br><span class="line">  	$password = arg(<span class="string">'password'</span>);</span><br><span class="line">  	<span class="keyword">if</span>(<span class="keyword">empty</span>($username)||<span class="keyword">empty</span>($password))&#123;</span><br><span class="line">  		<span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('Username or password is error.')&lt;/script&gt;"</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  	$password = md5($password);</span><br><span class="line">  	$user = <span class="keyword">New</span> User();</span><br><span class="line">  	$res = $user-&gt;query(<span class="string">"SELECT * FROM `&#123;$user-&gt;table_name&#125;` WHERE `username` ='&#123;$username&#125;'"</span>);</span><br><span class="line">  	<span class="keyword">if</span>(!<span class="keyword">empty</span>($res))&#123;</span><br><span class="line">  		<span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('Username is registered!.')&lt;/script&gt;"</span>;</span><br><span class="line">  	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  		$res = $user-&gt;create([</span><br><span class="line">  		<span class="string">"username"</span>=&gt;$username,</span><br><span class="line">  		<span class="string">"password"</span>=&gt;$password,</span><br><span class="line">  		<span class="string">"picture"</span>=&gt;<span class="string">"/img/pic.jpg"</span>]);</span><br><span class="line">  		<span class="keyword">if</span>(!$res) <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('something error. register fiaied!')&lt;/script&gt;"</span>;</span><br><span class="line">  		<span class="keyword">else</span> <span class="keyword">$this</span>-&gt;jump(<span class="string">"/main/login"</span>);</span><br><span class="line">  	&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>可以看出其对输入参数首先进行了arg函数的处理，我们找一下arg函数的位置，发现在core.php文件第163行（escape函数后面）<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arg</span><span class="params">($name, $default = null, $trim = false)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[$name])) &#123;</span><br><span class="line">        $arg = $_REQUEST[$name];</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($_SERVER[$name])) &#123;</span><br><span class="line">        $arg = $_SERVER[$name];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $arg = $default;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>($trim) &#123;</span><br><span class="line">        $arg = trim($arg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $arg;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p></p><p>对参数执行了 trim 去空格操作。</p><p>再看一下登录函数：<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">actionLogin</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>($_POST)&#123;</span><br><span class="line">    $username = arg(<span class="string">'username'</span>);</span><br><span class="line">    $password = arg(<span class="string">'password'</span>);</span><br><span class="line">    $ip = arg(<span class="string">'REMOTE_ADDR'</span>);</span><br><span class="line">    $userAgent = arg(<span class="string">'HTTP_USER_AGENT'</span>);</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">empty</span>($username) || <span class="keyword">empty</span>($password)) &#123;</span><br><span class="line">              <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('Username or password is empty.')&lt;/script&gt;"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      $user = <span class="keyword">New</span> User();</span><br><span class="line">      $password = md5($password);</span><br><span class="line">      $res = $user-&gt;query(<span class="string">"SELECT * FROM `$user-&gt;table_name` where `username`='&#123;$username&#125;' AND `password`='&#123;$password&#125;'"</span>);</span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">empty</span>($res) || $res[<span class="number">0</span>][<span class="string">'password'</span>]!==$password)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('Username or password is error.')&lt;/script&gt;"</span>;</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $session = <span class="keyword">new</span> Session($res[<span class="number">0</span>][<span class="string">"id"</span>],time(),$ip,$userAgent);</span><br><span class="line">        $_SESSION[<span class="string">'data'</span>] = serialize($session);</span><br><span class="line">        $_SESSION[<span class="string">'username'</span>] = $username;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;jump(<span class="string">"/main/index"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>审计可知如果登录成功会实例一个session类，而这个类在include文件夹 session.php 中定义。网站SESSION主要有两个参数，一个是 data ，一个是 username ， data 是上面实例化后的Session序列化的结果。</p><p>除此之外还可以文件上传：<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionUpload</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  $fileName = $_FILES[<span class="string">'upfile'</span>][<span class="string">'name'</span>];</span><br><span class="line">  $fileExt = <span class="keyword">isset</span>(pathinfo($fileName)[<span class="string">'extension'</span>])?pathinfo($fileName)[<span class="string">'extension'</span>]:<span class="string">"png"</span>;</span><br><span class="line">  $fileExt = addslashes($fileExt);</span><br><span class="line">  $filename = <span class="keyword">$this</span>-&gt;randomStr().<span class="string">'.'</span>.$fileExt;</span><br><span class="line">  $realFileName = APP_DIR.DS.<span class="string">"img"</span>.DS.<span class="string">"upload"</span>.DS.$filename;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(move_uploaded_file($_FILES[<span class="string">'upfile'</span>][<span class="string">'tmp_name'</span>],$realFileName))&#123;</span><br><span class="line">  	$user = <span class="keyword">New</span> User();</span><br><span class="line">  	$webFileName = DS.<span class="string">"img"</span>.DS.<span class="string">"upload"</span>.DS.$filename;</span><br><span class="line">  	$res = $user-&gt;execute(<span class="string">"UPDATE `&#123;$user-&gt;table_name&#125;` set `picture`='&#123;$webFileName&#125;' where `id`='&#123;$userId&#125;'"</span>);</span><br><span class="line">  	<span class="keyword">if</span>($res)&#123;</span><br><span class="line">  		<span class="keyword">echo</span> <span class="string">'&lt;script&gt;alert("Upload file success!")&lt;/script&gt;'</span>;</span><br><span class="line">  	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              <span class="keyword">echo</span> <span class="string">'&lt;script&gt;alert("Upload file error!")&lt;/script&gt;'</span>;</span><br><span class="line">  	&#125;</span><br><span class="line">  	<span class="keyword">$this</span>-&gt;jump(<span class="string">"/main/index"</span>);</span><br><span class="line">  	<span class="keyword">return</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  	<span class="keyword">echo</span> <span class="string">'&lt;script&gt;alert("Upload file Error!")&lt;/script&gt;'</span>;</span><br><span class="line">  	<span class="keyword">$this</span>-&gt;jump(<span class="string">"/main/index"</span>);</span><br><span class="line">  	<span class="keyword">return</span> ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>该函数主要对上传文件进行了重名名，对文件类型没有要求，可以上传php文件。但是在存储文件的文件夹里.htaccess限制了执行（php_flag engine off）</p><h2 id="0x05-文件包含"><a href="#0x05-文件包含" class="headerlink" title="0x05 文件包含"></a>0x05 文件包含</h2><p>涉及到php文件包含的漏洞，可以全局搜索include。<br><img src="https://i.loli.net/2018/12/19/5c1a2a859395f.png" alt=""><br>这里有四个地方出现include，后面两个涉及到view 视图操作，基本没有利用价值。前面两个是一个自动加载类函数，比较可疑，该函数位于core.php 50行左右：<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">spl_autoload_register(<span class="string">'inner_autoload'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inner_autoload</span><span class="params">($class)</span></span>&#123;</span><br><span class="line">	<span class="keyword">GLOBAL</span> $__module,$__custom;</span><br><span class="line">	$class = str_replace(<span class="string">"\\"</span>,<span class="string">"/"</span>,$class);</span><br><span class="line">	<span class="keyword">foreach</span>(<span class="keyword">array</span>(<span class="string">'model'</span>,<span class="string">'include'</span>,<span class="string">'controller'</span>.(<span class="keyword">empty</span>($__module)?<span class="string">''</span>:DS.$__module),$__custom) <span class="keyword">as</span> $dir)&#123;</span><br><span class="line">		$file = APP_DIR.DS.$dir.DS.$class.<span class="string">'.php'</span>;</span><br><span class="line">		<span class="keyword">if</span>(file_exists($file))&#123;</span><br><span class="line">			<span class="keyword">include</span> $file;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>sql_autoload_register 于php5中__autoload函数的作用是一样的，当实例化一个未定义的类时，就会触发此函数，其目的是避免书写过多的引用文件，使整个系统更加灵活。<br>前面有文件上传的接口，而且可以上传php文件，加入我们上传一个shell，如果在这里可以成功包含的话，Shell就可以执行了。这里的自动加载类函数会加载以未命名类的类名的文件，也就是说我们要把我们上传的文件生成的随机文件名记录下来，然后作为类想办法加载到这个函数里。</p><h2 id="0x06-session机制"><a href="#0x06-session机制" class="headerlink" title="0x06 session机制"></a>0x06 session机制</h2><p>按照前面的攻击思路，首先就要想办法触发inner_autoload函数，并把文件名作为参数传进去。也就是说要实例化一个类。涉及到类的实例化，全局搜索关键词‘new’, 一处是core.php 78行左右：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$controller_obj = new $controller_name();</span><br></pre></td></tr></table></figure><p></p><p>经过分析 $controller_name() = $__controller.’Controller’; 后缀必须有Controller，无法利用。<br>继续看发现一处对session的实例化操作，随之还进行了序列化：<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$session = <span class="keyword">new</span> Session($res[<span class="number">0</span>][<span class="string">"id"</span>],time(),$ip,$userAgent);</span><br><span class="line">$_SESSION[<span class="string">'data'</span>] = serialize($session);</span><br></pre></td></tr></table></figure><p></p><font color="red">有序列化就有反序列化，如果我们可以控制session的内容，使之变成一个我们自己定义的序列化后的类，那么反序列化之后就会对这个类进行实例化，进而触发自动加载类函数，完成文件包含。</font><p>下面我们对session的生成进行详细分析：<br>对于session生成，我根据代码简单做了一个结构图：<br><img src="https://i.loli.net/2018/12/15/5c146d861a478.png" alt=""><br>首先是core.php将main/index登录请求交给mainController类控制器中的actionIndex方法，在这之前继承BaseController类，该类重写了 SessionHandler 函数，使得 session 可以存储到数据库中。进而调用 session_start() 开启session会话机制。该函数会自动调用MySessionHandler中的open()和read()函数，进行数据库的连接和session的读取。不存在 session的话跳转到 actionLogin 类方法生成session。然后通过序列化触发write()方法将之写入数据库。</p><p>下面是session类<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span></span>&#123;</span><br><span class="line">   <span class="keyword">private</span> $ip ;</span><br><span class="line">   <span class="keyword">private</span> $userAgent;</span><br><span class="line">   <span class="keyword">private</span> $userId;</span><br><span class="line">   <span class="keyword">private</span> $loginTime ;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> $timeFormat = <span class="string">"H:i:s"</span>;</span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($userId,$loginTime,$ip=<span class="string">"0.0.0.0"</span>,$userAgent=<span class="string">""</span>)</span></span>&#123;</span><br><span class="line">       <span class="keyword">$this</span>-&gt;userId = $userId;</span><br><span class="line">       <span class="keyword">$this</span>-&gt;ip = $ip;</span><br><span class="line">       <span class="keyword">$this</span>-&gt;loginTime = $loginTime;</span><br><span class="line">       <span class="keyword">$this</span>-&gt;userAgent = $userAgent;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUserInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">array</span>(intval(<span class="keyword">$this</span>-&gt;userId),date(<span class="keyword">self</span>::$timeFormat,<span class="keyword">$this</span>-&gt;loginTime));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">isAccountSec</span><span class="params">($ip=<span class="string">"0.0.0.0"</span>,$userAgent=<span class="string">""</span>)</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> (<span class="keyword">$this</span>-&gt;ip === $ip &amp;&amp; <span class="keyword">$this</span>-&gt;userAgent === $userAgent);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">static</span> <span class="function"><span class="keyword">function</span>  <span class="title">getTime</span><span class="params">($timestamp)</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> date(<span class="keyword">self</span>::$timeFormat,$timestamp);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>Session由四部分组成，ip、useragent、userID、logintime。</p><p>拿到了$_SESSION[‘data’]，回到actionIndex函数。对于data，它会对其合法性进行判定：<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$session = unserialize($_SESSION[<span class="string">"data"</span>],[<span class="string">"allowed_classes"</span> =&gt; [<span class="string">"Session"</span>]]);</span><br><span class="line"><span class="comment">//第二个参数是反序列化的过滤机制,防止注入,转换所有对象到 __PHP_Incomplete_Class对象，除了session</span></span><br><span class="line">$ip = arg(<span class="string">"REMOTE_ADDR"</span>);</span><br><span class="line">$userAgent = arg(<span class="string">"HTTP_USER_AGENT"</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;now = $session::getTime(time());</span><br><span class="line"><span class="keyword">if</span>($session-&gt;isAccountSec($ip,$userAgent))&#123;</span><br><span class="line">	$userinfo = $session-&gt;getUserInfo();</span><br><span class="line">	<span class="keyword">$this</span>-&gt;username =  $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">	<span class="keyword">$this</span>-&gt;loginTime = $userinfo[<span class="number">1</span>];</span><br><span class="line">	$userId = $userinfo[<span class="number">0</span>];</span><br><span class="line">	$user = <span class="keyword">new</span> User();</span><br><span class="line">	$res = $user-&gt;query(<span class="string">"SELECT picture FROM `&#123;$user-&gt;table_name&#125;` where `id`='&#123;$userId&#125;'"</span>);</span><br><span class="line">	<span class="keyword">if</span>(!<span class="keyword">empty</span>($res))&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;picSrc = $res[<span class="number">0</span>][<span class="string">'picture'</span>];</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;picSrc = <span class="string">"/img/pic.jpg"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('your cookie my be stealed by hacker!');&lt;/script&gt;"</span>;</span><br><span class="line">	session_destroy();</span><br><span class="line">	<span class="keyword">$this</span>-&gt;jump(<span class="string">"/main/login"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>这里为了方便测试，我将生成session和验证session的代码脱出来单独测试，这是生成的$_SESSION[‘data’]和反序列化之后的结果：<br><img src="https://i.loli.net/2018/12/15/5c1460d314f59.png" alt=""></p><p>我们再看一下session的存储，这里它通过MySessionHandler类和session_set_save_handler重写了SessionHandlerInterface，使session能够存储在数据库里。session_start()函数会自动调用open和read函数去数据库检索session。<br>session的读取和写入有可能造成session伪造，下面是相关代码（MySessionHandler.php）<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">($session_id)</span></span>&#123;</span><br><span class="line">  $res = <span class="keyword">$this</span>-&gt;dbsession-&gt;query(<span class="string">"SELECT * FROM `&#123;$this-&gt;dbsession-&gt;table_name&#125;` where `sessionid` = '&#123;$session_id&#125;'"</span>);</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">empty</span>($res))&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> (string)@$res[<span class="number">0</span>][<span class="string">'data'</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($session_id,$data)</span></span>&#123;</span><br><span class="line">  $time = time();</span><br><span class="line">  $res = <span class="keyword">$this</span>-&gt;dbsession-&gt;query(<span class="string">"SELECT * FROM `&#123;$this-&gt;dbsession-&gt;table_name&#125;` where `sessionid` = '&#123;$session_id&#125;' "</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>($res)&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;dbsession-&gt;execute(<span class="string">"UPDATE `&#123;$this-&gt;dbsession-&gt;table_name&#125;` SET `data` = '&#123;$data&#125;',`lastvisit` = '&#123;$time&#125;' where `sessionid` = '&#123;$session_id&#125;'"</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">    $res = <span class="keyword">$this</span>-&gt;dbsession-&gt;create(</span><br><span class="line">        [<span class="string">"data"</span>=&gt;$data,</span><br><span class="line">        <span class="string">"sessionid"</span>=&gt;$session_id,</span><br><span class="line">        <span class="string">"lastvisit"</span>=&gt;$time]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>write函数是将session的数据写到相应的位置去。<font color="red">当操作$_SESSION来序列化数据的时候该函数被触发。</font>对于write()更深的理解在下面这个图里：<br><img src="https://i.loli.net/2018/12/17/5c174c44db08c.png" alt=""></p><p>也就是说session数据会更新。所以存到数据库后的session不只是 session[‘data’] , 还有session[‘username’]，比如下面这样(存在不可打印字符)：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data|s:288:&quot;O:7:&quot;Session&quot;:4:&#123;s:11:&quot; Session ip&quot;;s:9:&quot;127.0.0.1&quot;;s:18:&quot; Session userAgent&quot;;s:128:&quot;Mozilla/5.0 ?Macintosh; Intel Mac OS X 10_14_0? AppleWebKit/537.36 ?KHTML, like Gecko? Chrome/69.0.3497.92 Safari/537.36&quot;;s:15:&quot; Session userId&quot;;s:1:&quot;1&quot;;s:18:&quot; Session loginTime&quot;;i:1543310132;&#125;&quot;;username|s:4:&quot;test&quot;;</span><br></pre></td></tr></table></figure><p></p><p>好了，我们搞清楚了session的生成、存储及构成方式，那么有没有办法伪造session成我们想要的内容呢。<font color="red">这里有两个思路，一个是session是存在数据库里的，是否可以通过注入进行修改呢。第二个思路是在在写入之前或读取之后利用代码漏洞进行修改。</font></p><h2 id="0x07-任意session伪造"><a href="#0x07-任意session伪造" class="headerlink" title="0x07 任意session伪造"></a>0x07 任意session伪造</h2><p>这里主要是以第一个思路为主（据说是预期解法），我在这里复现一下。这里存在一个任意session伪造漏洞，我从源代码里将关键函数和类拷出来并进行做了一个压缩版方便调试和审计，其主要逻辑就是session的生成过程及存储过程。下面我们将整个流程演示一遍：<br>第一步：带参数登录生成session<br>下面是我请求的url：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/ctftest/XUA-web/hardphp.php?username=leeswi\\\\</span><br></pre></td></tr></table></figure><p></p><p>生成结果：<br><img src="https://i.loli.net/2018/12/22/5c1d8f2b1a308.png" alt=""><br>这里问题就发生了，我们可以看出来我们输入的username是leeswi\\\\<br>经过escape过滤之后变成了leeswi\\\\\\\\，并且将其序列化<br>但是由于写入数据库的时候反斜杠自动转义，username又成了leeswi\\\\<br>但是前面还是s:14，这在反序列化时就会出错，因为后面只剩10个字符而不是14个了。<br><img src="https://i.loli.net/2018/12/22/5c1d902806b10.png" alt=""><br>如上图，我们再次访问，session会从数据库读出来并反序列化，反序列化出错decode fail进而触发destroy函数进行销毁。<br>按照<a href="https://xz.aliyun.com/t/3453" target="_blank" rel="noopener">wonderkun</a>大佬的思路是这样的，上传一个 php shell 文件，然后记录下其文件名，例如： 28mlzz380bs8e4sr6e98xzqxbdx2lj9m.php<br>再注册一个账户，账户名为： ;data|s:40:”s:32:”28mlzz380bs8e4sr6e98xzqxbdx2lj9m”;<br>用上面的账号登录，设置 User-Agent为 \\\\\\\\ 16个反斜杠，根据自己的情况调整。<br>然后访问 <a href="http://127.0.0.1:8888/main/index?s=img/upload/" target="_blank" rel="noopener">http://127.0.0.1:8888/main/index?s=img/upload/</a> 就getshell了。简单来说，就是伪造成这样：<br><img src="https://i.loli.net/2018/12/24/5c20d0dbb60ce.png" alt=""><br>下面是响应：<br><img src="https://i.loli.net/2018/12/24/5c20d14309a92.png" alt=""><br>再次访问，getshell（为了简化我把shell直接放到了同目录下）<br><img src="https://i.loli.net/2018/12/24/5c20d19746872.png" alt=""><br>接下来就有问题了，为什么这个session中useragent插入16个反斜杠后会将;username|s:52:”覆盖掉呢？？？</p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/web/" rel="tag"># web</a> <a href="/tags/代码审计/" rel="tag"># 代码审计</a> <a href="/tags/X-nuca/" rel="tag"># X'nuca</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/12/08/20181207：Django结构图/" rel="next" title="Django结构图"><i class="fa fa-chevron-left"></i> Django结构图</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC80MTQ3OC8xODAyNQ=="></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/header.jpg" alt="Sing1e-D0g"><p class="site-author-name" itemprop="name">Sing1e-D0g</p><p class="site-description motion-element" itemprop="description">孤独的人是可耻的</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">3</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">29</span> <span class="site-state-item-name">标签</span></a></div></nav></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-题目"><span class="nav-number">1.</span> <span class="nav-text">0x01 题目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-简单分析"><span class="nav-number">2.</span> <span class="nav-text">0x02 简单分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-core-php文件分析"><span class="nav-number">3.</span> <span class="nav-text">0x03 core.php文件分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-Controller控制器分析"><span class="nav-number">4.</span> <span class="nav-text">0x04 Controller控制器分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-文件包含"><span class="nav-number">5.</span> <span class="nav-text">0x05 文件包含</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-session机制"><span class="nav-number">6.</span> <span class="nav-text">0x06 session机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x07-任意session伪造"><span class="nav-number">7.</span> <span class="nav-text">0x07 任意session伪造</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2018</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Sing1e-D0g</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><span class="post-meta-divider">|</span><div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((n=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script></body></html><script type="text/javascript" src="/js/src/love.js"></script>